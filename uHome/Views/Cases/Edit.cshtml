@model uHome.Models.EditCaseViewModel

@{
    ViewBag.Title = "Edit";
}
<h4>@Model.Title</h4>

<div class="container">
    <div class="row">
        <div class="col-md-8">
            <hr />
            <dl>
                <dt>Description</dt>
                <dd class="well well-lg">@Model.Description</dd>
                <dt>Attachments</dt>
                <dd>
                    <div class="container" id="attachments">
                        <div class="row">
                            <div class="col-md-6">Name</div>
                            <div class="col-md-3">Upload At</div>
                            <div class="col-md-3">Size</div>
                        </div>
                        @foreach (var attachment in Model.Attachments)
                        {
                            <div class="row" id="attachment_@attachment.ID">
                                <div class="col-md-6">@Html.ActionLink(attachment.Name, "Download", "Attachments", new { id = attachment.ID }, null)</div>
                                <div class="col-md-3">@attachment.UploadAt</div>
                                <div class="col-md-2">@attachment.Size</div>
                                <div class="col-md-1">
                                    @Ajax.RawActionLink(
                                    "<span class=\"glyphicon glyphicon-trash\"></span>",
                                    "Delete",
                                    "Attachments",
                                    new { id = attachment.ID },
                                    new AjaxOptions
                                    {
                                        Confirm = string.Format("Are you sure you want ot delete {0}?", attachment.Name),
                                        OnBegin = "showSpinner",
                                        OnComplete = "hideSpinner",
                                        OnSuccess = "onAttachmentDeleteSuccess",
                                        OnFailure = "onAttachmentDeleteFailure",
                                        HttpMethod = "DELETE"
                                    }, null)
                                </div>
                            </div>
                        }
                    </div>
                </dd>
            </dl>
        </div>
        <div class="col-md-4">
            <hr />
            <dl class="dl-horizontal">
                <dt>Created By</dt>
                <dd>@Model.CreatedBy</dd>
                <dt>Created At</dt>
                <dd>@Model.CreatedAt</dd>
                <dt>Updated At</dt>
                <dd id="UpdatedAt">@Model.UpdatedAt</dd>
                <dt>State</dt>
                <dd>@Model.State</dd>
                <dt>Assignee</dt>
                <dd>@Model.Assignee</dd>
                <dd id="plupload_container">
                    <span id="filelist"></span>
                    <a id="pickfiles" href="javascript:;" class="btn btn-default">[Select files]</a>
                    <a id="uploadfiles" href="javascript:;" class="btn btn-default">[Upload files]</a>
                    <pre id="console"></pre>
                </dd>
            </dl>
        </div>
    </div>
</div>

<div>
    @Html.ActionLink("Back to List", "Index")
</div>

@section Scripts {
    @*@Scripts.Render("~/bundles/uploadify")*@
    @Scripts.Render("~/bundles/plupload")

    <script type="text/javascript">
        @*$(document).ready(function () {
            $('#file_upload').uploadify({
                'buttonClass': "btn btn-info btn-xs",
                'buttonText': "Add attachments",
                'fileSizeLimit': "10MB",
                'fileTypeExts': "*.doc; *.docx; *.xls; *.xlsx; *.pdf; *.jpg; *.gif; *.png",
                'swf': "@Url.Content("~/Content/Images/uploadify.swf")",
                'cancelImg': "@Url.Content("~/Content/Images/uploadify-cancel.png")",
                'uploader': "@Url.Action("AddFile", "Cases", new { id = Model.ID })",
                'onUploadSuccess': function (file, data, response) {
                    var data = $.parseJSON(data);
                    if (data.success)
                    {
                        $('#attachments').append(data.newAttachment);
                        $('#UpdatedAt').text(data.updatedAt);
                    }
                    else
                    {
                        alert(data.errMsg);
                    }
                }
            });
        });*@

        var uploader = new plupload.Uploader({
            runtimes: 'html5, html4',
            browse_button: 'pickfiles',
            container: document.getElementById('plupload_container'),
            url: "@Url.Action("AddFiles", "Cases", new { id = Model.ID })",

            filters: {
                max_file_size: '10mb',
            },

            init: {
                PostInit: function () {
                    document.getElementById('filelist').innerHTML = '';

                    document.getElementById('uploadfiles').onclick = function () {
                        uploader.start();

                        return false;
                    };
                },

                FilesAdded: function (up, files) {
                    plupload.each(files, function (file) {
                        document.getElementById('filelist').innerHTML += '<div id="' + file.id + '">' + file.name + ' (' + plupload.formatSize(file.size) + ') <b></b></div>';
                    });
                },

                UploadProgress: function (up, file) {
                    document.getElementById(file.id).getElementsByTagName('b')[0].innerHTML = '<span>' + file.percent + "%</span>";
                },

                Error: function (up, err) {
                    document.getElementById('console').innerHTML += "\nError #" + err.code + ": " + err.message;
                }
            }
        });

        uploader.init();

        function onAttachmentDeleteSuccess(response)
        {
            if (response.success)
            {
                var id = "#attachment_" + response.id;
                $(id).remove();
                $('#UpdatedAt').val(response.updatedAt);
            }
            else {
                alert(response.error);
            }
        }
    </script>
}
